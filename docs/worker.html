<!DOCTYPE html>  <html> <head>   <title>worker.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="audit_log.html">                 audit_log.coffee               </a>                                           <a class="source" href="consts.html">                 consts.coffee               </a>                                           <a class="source" href="control_channel.html">                 control_channel.coffee               </a>                                           <a class="source" href="db.html">                 db.coffee               </a>                                           <a class="source" href="dispatcher.html">                 dispatcher.coffee               </a>                                           <a class="source" href="doctor.html">                 doctor.coffee               </a>                                           <a class="source" href="redeye.html">                 redeye.coffee               </a>                                           <a class="source" href="request_channel.html">                 request_channel.coffee               </a>                                           <a class="source" href="response_channel.html">                 response_channel.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                                           <a class="source" href="work_queue.html">                 work_queue.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               worker.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">consts = </span><span class="nx">require</span> <span class="s">&#39;./consts&#39;</span>
<span class="nv">db = </span><span class="nx">require</span> <span class="s">&#39;./db&#39;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nx">require</span> <span class="s">&#39;./util&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Counts the number of simultaneous workers.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">num_workers = </span><span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The worker class is the context under which runner functions are run.</p>

<p>FIXME: @keys and @get_now don't work with @async !!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Worker</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Find the runner for the <code>@key</code>. The key is in the format:</p>

<pre><code>prefix:arg1:arg2:...
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@key, @queue, @sticky) -&gt;</span>
    <span class="p">[</span><span class="nx">@prefix</span><span class="p">,</span> <span class="nx">args</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">@key</span><span class="p">.</span><span class="nx">split</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">arg_sep</span>
    <span class="vi">@args = </span><span class="nx">args</span> <span class="c1"># weird bug in coffeescript: wanted @args... in line above</span>
    <span class="vi">@db = </span><span class="nx">@queue</span><span class="p">.</span><span class="nx">worker_db</span>
    <span class="vi">@req_channel = </span><span class="nx">_</span><span class="p">(</span><span class="s">&#39;requests&#39;</span><span class="p">).</span><span class="nx">namespace</span> <span class="nx">@queue</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@resp_channel = </span><span class="nx">_</span><span class="p">(</span><span class="s">&#39;responses&#39;</span><span class="p">).</span><span class="nx">namespace</span> <span class="nx">@queue</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@cache = </span><span class="p">{}</span>
    <span class="vi">@saved_keys = </span><span class="p">{}</span>
    <span class="vi">@cycle = </span><span class="p">{}</span>
    <span class="vi">@emitted_key = </span><span class="p">{}</span>
    <span class="vi">@sequence = </span><span class="p">[]</span>
    <span class="vi">@last_stage = </span><span class="mi">0</span>
    <span class="nx">unless</span> <span class="vi">@runner = </span><span class="nx">@queue</span><span class="p">.</span><span class="nx">runners</span><span class="p">[</span><span class="nx">@prefix</span><span class="p">]</span>
      <span class="nx">@emit</span> <span class="nx">@key</span><span class="p">,</span> <span class="kc">null</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;no runner for &#39;</span><span class="si">#{</span><span class="nx">@prefix</span><span class="si">}</span><span class="s">&#39; (</span><span class="si">#{</span><span class="nx">@key</span><span class="si">}</span><span class="s">)&quot;</span>
      <span class="k">throw</span> <span class="s">&#39;no_runner&#39;</span>
    <span class="nx">num_workers</span><span class="o">++</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Mark the worker as asynchronous. If a callback is provided, it's
run in the context of the worker.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">async: </span><span class="nf">(callback) -&gt;</span>
    <span class="vi">@is_async = </span><span class="kc">true</span>
    <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;function&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Print a debugging statement</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">debug: </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>console.log 'worker:', args...</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>If we've already seen this <code>@get</code> before, then return the actual
value we've received (which we know we got because otherwise we
wouldn't be running again). Otherwise, just mark this dependency
and return <code>undefined</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get: </span><span class="nf">(args...) -&gt;</span>
    <span class="nv">on_cycle = </span><span class="nx">_</span><span class="p">(</span><span class="nx">args</span><span class="p">).</span><span class="nx">callback</span><span class="p">()</span>
    <span class="nv">opts = </span><span class="nx">_</span><span class="p">(</span><span class="nx">args</span><span class="p">).</span><span class="nx">opts</span><span class="p">()</span>
    <span class="nv">key = </span><span class="nx">args</span><span class="p">.</span><span class="nx">join</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">arg_sep</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>@check_stage key</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@stage</span> <span class="o">==</span> <span class="nx">@last_stage</span>
      <span class="nx">@notify_dep</span> <span class="nx">key</span>
    <span class="k">if</span> <span class="nx">@sticky</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">@sticky</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@cycle</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">on_cycle</span>
      <span class="nx">@cache</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">on_cycle</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@stage</span> <span class="o">&lt;</span> <span class="nx">@last_stage</span>
      <span class="nv">value = </span><span class="nx">@build</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">as</span>
      <span class="nx">@sticky</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">if</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">sticky</span>
      <span class="nx">value</span>
    <span class="k">else</span>
      <span class="nx">@deps</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
      <span class="nx">@blank</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Notify the dispatcher of our dependency (regardless of whether we're
going to request that key).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">notify_dep: </span><span class="nf">(key) -&gt;</span>
    <span class="nv">msg = </span><span class="p">[</span><span class="s">&#39;!dep&#39;</span><span class="p">,</span> <span class="nx">@key</span><span class="p">,</span> <span class="nx">key</span><span class="p">].</span><span class="nx">join</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">key_sep</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@req_channel</span><span class="p">,</span> <span class="nx">msg</span>
  </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Return an instance of the default, not-yet-instantiated object. If
<code>@wrapper</code> was called, then it's an instance of this clas with <code>undefined</code>
as its value. Otherwise, an unwrapped <code>undefined</code> is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">blank: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@wrapper_class</span><span class="o">?</span>
      <span class="k">new</span> <span class="nx">@wrapper_class</span><span class="p">(</span><span class="kc">undefined</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="kc">undefined</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Make sure the given key is being requested in a totally legal and consistent way.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check_stage: </span><span class="nf">(key) -&gt;</span>
    <span class="k">if</span> <span class="nx">@key_index</span> <span class="o">==</span> <span class="nx">@sequence</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">@sequence</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">@sequence</span><span class="p">[</span><span class="nx">@key_index</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">key</span>
        <span class="k">throw</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@key</span><span class="si">}</span><span class="s"> has a nondeterministic key sequence; expected </span><span class="si">#{</span><span class="nx">@sequence</span><span class="p">[</span><span class="nx">@key_index</span><span class="p">]</span><span class="si">}</span><span class="s">, but got </span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s"> (sequence: </span><span class="si">#{</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">@sequence</span><span class="p">)</span><span class="si">}</span><span class="s">)&quot;</span>
    <span class="nx">@key_index</span><span class="o">++</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Search for the given keys in the database, then remember them.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">keys: </span><span class="nf">(str) -&gt;</span>
    <span class="k">if</span> <span class="nx">@saved_keys</span><span class="p">[</span><span class="nx">str</span><span class="p">]</span>
      <span class="nx">@saved_keys</span><span class="p">[</span><span class="nx">str</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="vi">@search = </span><span class="nx">str</span>
      <span class="k">throw</span> <span class="s">&#39;resolve&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>This is a bit of syntactic sugar. It's the equivalent of:</p>

<pre><code>x = @get key
@for_reals()
x
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_now: </span><span class="o">-&gt;</span>
    <span class="nv">value = </span><span class="nx">@get</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="nx">@for_reals</span><span class="p">()</span>
    <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>If a klass is given, construct a new one; otherwise, just return
the raw value.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">build: </span><span class="nf">(value, klass) -&gt;</span>
    <span class="nx">klass</span> <span class="o">?=</span> <span class="nx">@wrapper_class</span>
    <span class="k">if</span> <span class="nx">klass</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@bless</span><span class="p">(</span><span class="k">new</span> <span class="nx">klass</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="k">else</span> <span class="nx">value</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Extend the given object with the context methods of a worker,
in addition to a recursive blessing.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bless: </span><span class="nf">(object) -&gt;</span>
    <span class="k">for</span> <span class="nx">method</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;get&#39;</span><span class="p">,</span> <span class="s">&#39;emit&#39;</span><span class="p">,</span> <span class="s">&#39;for_reals&#39;</span><span class="p">,</span> <span class="s">&#39;get_now&#39;</span><span class="p">,</span> <span class="s">&#39;keys&#39;</span><span class="p">,</span> <span class="s">&#39;worker&#39;</span><span class="p">]</span>
      <span class="nx">do</span> <span class="nf">(method) -&gt;</span> <span class="nx">object</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nx">Worker</span><span class="p">.</span><span class="nx">current</span><span class="p">[</span><span class="nx">method</span><span class="p">].</span><span class="nx">apply</span> <span class="nx">Worker</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="k">for</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">fun</span> <span class="k">of</span> <span class="nx">Worker</span><span class="p">.</span><span class="nx">mixins</span>
      <span class="nx">do</span> <span class="nf">(method, fun) -&gt;</span> <span class="nx">object</span><span class="p">[</span><span class="nx">method</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span>
        <span class="nx">fun</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">Worker</span><span class="p">.</span><span class="nx">current</span><span class="p">,</span> <span class="nx">arguments</span>
    <span class="nv">object.bless = </span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@bless</span> <span class="nx">next</span>
    <span class="nx">object</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Produce <code>value</code> as a result for <code>key</code>. This both puts the result
in redis under the key and tells the dispatcher (via the <code>responses</code>
channel) that the job is done.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">emit: </span><span class="nf">(args..., value) -&gt;</span>
    <span class="vi">@emitted = </span><span class="kc">true</span>
    <span class="nv">key = </span><span class="nx">args</span><span class="p">.</span><span class="nx">join</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">arg_sep</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@emitted_key</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">@emitted_key</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nv">json = </span><span class="nx">value</span><span class="o">?</span><span class="p">.</span><span class="nx">toJSON</span><span class="o">?</span><span class="p">()</span> <span class="o">?</span> <span class="nx">value</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@resp_channel</span><span class="p">,</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>If we've seen this <code>@for_reals</code> before, then blow right past it.
Otherwise, abort the runner function and start over (after checking
that our dependencies are met).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">for_reals: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@stage</span> <span class="o">==</span> <span class="nx">@last_stage</span>
      <span class="k">if</span> <span class="nx">@deps</span><span class="p">.</span><span class="nx">length</span>
        <span class="k">if</span> <span class="nx">@is_async</span>
          <span class="nx">@resolve</span><span class="p">()</span>
          <span class="k">return</span> <span class="kc">false</span>          
        <span class="k">else</span>
          <span class="k">throw</span> <span class="s">&#39;resolve&#39;</span>
      <span class="nx">@last_stage</span><span class="o">++</span>
    <span class="nx">@stage</span><span class="o">++</span>
    <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Attempt to run the runner function. If a call to <code>@for_reals</code> causes
us to abort, then attempt to resolve the dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">run: </span><span class="o">-&gt;</span>
    <span class="k">try</span>
      <span class="nx">@clear</span><span class="p">()</span>
      <span class="nx">@process</span><span class="p">()</span>
    <span class="k">catch</span> <span class="nx">err</span>
      <span class="nx">@caught</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Reset information about this run, including:</p>

<ul>
<li><code>@stage</code>: how many calls to <code>@for_reals</code> we've seen</li>
<li><code>@deps</code>: a list of new dependencies</li>
<li><code>@emitted</code>: whether <code>@emit</code> has been called.</li>
<li><code>@search</code>: the key search currently requested</li>
<li><code>@is_async</code>: whether the worker is in async mode</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clear: </span><span class="o">-&gt;</span>
    <span class="vi">@stage = </span><span class="mi">0</span>
    <span class="vi">@key_index = </span><span class="mi">0</span>
    <span class="vi">@deps = </span><span class="p">[]</span>
    <span class="vi">@emitted = </span><span class="kc">false</span>
    <span class="vi">@search = </span><span class="kc">null</span>
    <span class="vi">@is_async = </span><span class="kc">false</span>
    <span class="nx">Worker</span><span class="p">.</span><span class="nx">clear_callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If the caught error is from a <code>@for_reals</code>, then try to resolve
dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">caught: </span><span class="nf">(err) -&gt;</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="s">&#39;resolve&#39;</span>
      <span class="nx">@resolve</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span><span class="p">.</span><span class="nx">is_cycle</span>
      <span class="nx">@cycle_failure</span> <span class="nx">err</span><span class="p">.</span><span class="nx">key</span>
    <span class="k">else</span>
      <span class="nx">@error</span> <span class="nx">err</span>
    </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Mark that a fatal exception occurred</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">error: </span><span class="nf">(err) -&gt;</span>
    <span class="nv">message = </span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span> <span class="o">?</span> <span class="nx">err</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">message</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;fatal&#39;</span><span class="p">,</span> <span class="nx">message</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Call the runner. If it gets all the way through, first check if there
were any unmet dependencies after the last <code>@for_reals</code>. If so, we force
one last dependency resolution. Otherwise, we optionally
emit the result of the function (if nothing has been emitted yet).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">process: </span><span class="o">-&gt;</span>
    <span class="nv">Worker.current = </span><span class="k">this</span>
    <span class="nv">result = </span><span class="nx">@runner</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@args</span>
    <span class="k">return</span> <span class="nx">@resolve</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@deps</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">@finish</span> <span class="nx">result</span> <span class="nx">unless</span> <span class="nx">@is_async</span>
  </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>We're done!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finish: </span><span class="nf">(result) -&gt;</span>
    <span class="nx">Worker</span><span class="p">.</span><span class="nx">finish_callback</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span>
    <span class="nx">num_workers</span><span class="o">--</span>
    <span class="nx">@queue</span><span class="p">.</span><span class="nx">finish</span> <span class="nx">@key</span>
    <span class="nx">@emit</span> <span class="nx">@key</span><span class="p">,</span> <span class="p">(</span><span class="nx">result</span> <span class="o">?</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">@emitted</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Compare the provided values against our current dependencies.
Missing dependencies are returned in an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">check_values: </span><span class="nf">(arr) -&gt;</span>
    <span class="nv">bad = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">dep</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@deps</span>
      <span class="nx">@cache</span><span class="p">[</span><span class="nx">dep</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
      <span class="nx">bad</span><span class="p">.</span><span class="nx">push</span> <span class="nx">dep</span> <span class="nx">unless</span> <span class="nx">@cache</span><span class="p">[</span><span class="nx">dep</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">bad</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>The first step in resolving dependencies from a <code>@for_reals</code> is
to record that there's one more of them to get through, then to check
the dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolve: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@search</span>
      <span class="nx">@db</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">@search</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">keys</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@saved_keys</span><span class="p">[</span><span class="nx">@search</span><span class="p">]</span> <span class="o">=</span> <span class="nx">keys</span>
        <span class="nx">@run</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">@last_stage</span><span class="o">++</span>
      <span class="nx">@get_deps</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Ask redis to provide values for our dependencies. If any are missing,
send a request to the dispatcher; otherwise, resume trying to run the
main function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">get_deps: </span><span class="nf">(force = false) -&gt;</span>
    <span class="k">throw</span> <span class="s">&quot;No dependencies to get: </span><span class="si">#{</span><span class="nx">@key</span><span class="si">}</span><span class="s">&quot;</span> <span class="nx">unless</span> <span class="nx">@deps</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">mget</span> <span class="nx">@deps</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">arr</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="nx">@error</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
      <span class="nv">bad = </span><span class="nx">@check_values</span> <span class="nx">arr</span>
      <span class="k">if</span> <span class="nx">bad</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">force</span>
        <span class="nx">@request_missing</span> <span class="nx">bad</span>
      <span class="k">else</span>
        <span class="nx">@run</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Ask the dispatcher to providethe given keys by publishing on the
<code>requests</code> channel. Then block-wait to be signalled by a response
on a resume key. Once we get that response, try again to fetch the
dependencies (which should all be present).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">request_missing: </span><span class="nf">(keys) -&gt;</span>
    <span class="nv">request = </span><span class="p">[</span><span class="nx">@key</span><span class="p">,</span> <span class="nx">keys</span><span class="p">...].</span><span class="nx">join</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">key_sep</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@req_channel</span><span class="p">,</span> <span class="nx">request</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>The dispatcher said to resume, so go look for the missing values again. If
we're resuming from a cycle failure, go grab the key.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resume: </span><span class="o">-&gt;</span>
    <span class="nx">@get_deps</span> <span class="kc">true</span>
  </pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The given key is part of a cycle and we depend on it. Mark it as being cyclical.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cycle_detected: </span><span class="nf">(keys) -&gt;</span>
    <span class="nx">@cycle</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
    <span class="nx">@last_stage</span><span class="o">--</span>
    <span class="nx">@run</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Set the default wrapper class, which is overridden by <code>as:</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrapper: </span><span class="nf">(klass) -&gt;</span>
    <span class="vi">@wrapper_class = </span><span class="nx">klass</span>
  </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Return the current worker</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">worker: </span><span class="o">-&gt;</span>
    <span class="nx">Worker</span><span class="p">.</span><span class="nx">current</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Extend the blessed methods with the given ones, so that
worker contexts can use them.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Worker.mixin = </span><span class="nf">(mixins) -&gt;</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">(</span><span class="nx">Worker</span><span class="p">.</span><span class="nx">mixins</span> <span class="o">?=</span> <span class="p">{}),</span> <span class="nx">mixins</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">Worker</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">mixins</span>

<span class="nv">module.exports = </span><span class="nx">Worker</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 