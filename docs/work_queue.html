<!DOCTYPE html>  <html> <head>   <title>work_queue.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="audit_log.html">                 audit_log.coffee               </a>                                           <a class="source" href="consts.html">                 consts.coffee               </a>                                           <a class="source" href="control_channel.html">                 control_channel.coffee               </a>                                           <a class="source" href="db.html">                 db.coffee               </a>                                           <a class="source" href="dispatcher.html">                 dispatcher.coffee               </a>                                           <a class="source" href="doctor.html">                 doctor.coffee               </a>                                           <a class="source" href="redeye.html">                 redeye.coffee               </a>                                           <a class="source" href="request_channel.html">                 request_channel.coffee               </a>                                           <a class="source" href="response_channel.html">                 response_channel.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                                           <a class="source" href="work_queue.html">                 work_queue.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               work_queue.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Worker = </span><span class="nx">require</span> <span class="s">&#39;./worker&#39;</span>
<span class="nv">events = </span><span class="nx">require</span> <span class="s">&#39;events&#39;</span>
<span class="nv">consts = </span><span class="nx">require</span> <span class="s">&#39;./consts&#39;</span>
<span class="nv">db = </span><span class="nx">require</span> <span class="s">&#39;./db&#39;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nx">require</span> <span class="s">&#39;./util&#39;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The <code>WorkQueue</code> accepts job requests and starts <code>Worker</code> objects
to handle them.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">WorkQueue</span> <span class="k">extends</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Register the 'next' event, and listen for 'resume' messages.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@options) -&gt;</span>
    <span class="vi">@db = </span><span class="nx">db</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@control = </span><span class="nx">db</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@worker_db = </span><span class="nx">db</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@workers = </span><span class="p">{}</span>
    <span class="vi">@runners = </span><span class="p">{}</span>
    <span class="vi">@sticky = </span><span class="p">{}</span>
    <span class="vi">@mixins = </span><span class="p">{}</span>
    <span class="nx">@listen</span><span class="p">()</span>
    <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;next&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@next</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Subscribe to channels</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">listen: </span><span class="o">-&gt;</span>
    <span class="nx">@control</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">msg</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@perform</span> <span class="nx">msg</span>
    <span class="nx">@control</span><span class="p">.</span><span class="nx">subscribe</span> <span class="nx">_</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">).</span><span class="nx">namespace</span><span class="p">(</span><span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span><span class="p">)</span>
  </pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>React to a control message sent by the dispatcher</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">perform: </span><span class="nf">(msg) -&gt;</span>
    <span class="p">[</span><span class="nx">action</span><span class="p">,</span> <span class="nx">args</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">split</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">key_sep</span>
    <span class="k">switch</span> <span class="nx">action</span>
      <span class="k">when</span> <span class="s">&#39;resume&#39;</span> <span class="k">then</span> <span class="nx">@resume</span> <span class="nx">args</span><span class="p">...</span>
      <span class="k">when</span> <span class="s">&#39;erase&#39;</span> <span class="k">then</span> <span class="nx">@erase</span> <span class="nx">args</span><span class="p">...</span>
      <span class="k">when</span> <span class="s">&#39;quit&#39;</span> <span class="k">then</span> <span class="nx">@quit</span><span class="p">()</span>
      <span class="k">when</span> <span class="s">&#39;reset&#39;</span> <span class="k">then</span> <span class="nx">@reset</span><span class="p">()</span>
      <span class="k">when</span> <span class="s">&#39;cycle&#39;</span> <span class="k">then</span> <span class="nx">@cycle_detected</span> <span class="nx">args</span><span class="p">...</span>
      <span class="k">when</span> <span class="s">&#39;info&#39;</span> <span class="k">then</span> <span class="nx">@dump_info</span><span class="p">()</span>
  
  <span class="nv">dump_info: </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
      </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Resume the given worker (if it's one of ours)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resume: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@workers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">resume</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Erase the given key from the sticky cache (it was invalidated).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">erase: </span><span class="nf">(key) -&gt;</span>
    <span class="k">delete</span> <span class="nx">@sticky</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The dispatcher is telling us the given key is part of a cycle. If it's one
of ours, cause the worker to re-run, but throwing an error from the @get that
caused the cycle. On the plus side, we can assume that all the worker's non-
cycled dependencies have been met now.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cycle_detected: </span><span class="nf">(key, dependencies...) -&gt;</span>
    <span class="nx">@workers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">cycle_detected</span> <span class="nx">dependencies</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Run the work queue, calling the given callback on completion</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">run: </span><span class="nf">(@callback) -&gt;</span>
    <span class="nx">@next</span><span class="p">()</span>  
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Add a worker to the context</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">worker: </span><span class="nf">(prefix, runner) -&gt;</span>
    <span class="nx">@runners</span><span class="p">[</span><span class="nx">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="nx">runner</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Look for the next job using BLPOP on the "jobs" queue. This
will use an event emitter to call <code>next</code> again, so the stack
doesn't get large.</p>

<p>You can push the job <code>!quit</code> to make the work queue die.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">next: </span><span class="o">-&gt;</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">blpop</span> <span class="s">&#39;jobs&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">str</span><span class="p">])</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">@emit</span> <span class="s">&#39;next&#39;</span>
        <span class="k">return</span> <span class="nx">@error</span> <span class="nx">err</span>
      <span class="k">try</span>
        <span class="nx">@workers</span><span class="p">[</span><span class="nx">str</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Worker</span><span class="p">(</span><span class="nx">str</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@sticky</span><span class="p">)</span>
        <span class="nx">@workers</span><span class="p">[</span><span class="nx">str</span><span class="p">].</span><span class="nx">run</span><span class="p">()</span>
      <span class="k">catch</span> <span class="nx">e</span>
        <span class="nx">@error</span> <span class="nx">e</span> <span class="nx">unless</span> <span class="nx">e</span> <span class="o">==</span> <span class="s">&#39;no_runner&#39;</span>
      <span class="nx">@emit</span> <span class="s">&#39;next&#39;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Shut down the redis connection and stop running workers</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">quit: </span><span class="o">-&gt;</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">@control</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">@worker_db</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">@callback</span><span class="o">?</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Clean out the sticky cache</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reset: </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&#39;worker resetting&#39;</span>
    <span class="vi">@sticky = </span><span class="p">{}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Mark the given worker as finished (release its memory)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">finish: </span><span class="nf">(key) -&gt;</span>
    <span class="k">delete</span> <span class="nx">@workers</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Mark that a fatal exception occurred</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">error: </span><span class="nf">(err) -&gt;</span>
    <span class="nv">message = </span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span> <span class="o">?</span> <span class="nx">err</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">message</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;fatal&#39;</span><span class="p">,</span> <span class="nx">message</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Print a debugging statement</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">debug: </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>console.log 'queue:', args...</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Alias for <code>Worker.mixin</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mixin: </span><span class="nf">(mixins) -&gt;</span>
    <span class="nx">Worker</span><span class="p">.</span><span class="nx">mixin</span> <span class="nx">mixins</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Provide a callback to be executed in the context
of a worker whenever it has finished running, but before
saving its resutlts</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_finish: </span><span class="nf">(callback) -&gt;</span>
    <span class="nv">Worker.finish_callback = </span><span class="nx">callback</span>
    <span class="k">this</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Provide a callback to be called every time the worker begings running</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_clear: </span><span class="nf">(callback) -&gt;</span>
    <span class="nv">Worker.clear_callback = </span><span class="nx">callback</span>
    <span class="k">this</span>


<span class="nv">module.exports = </span><span class="nx">WorkQueue</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 