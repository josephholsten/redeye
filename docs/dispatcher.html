<!DOCTYPE html>  <html> <head>   <title>dispatcher.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="audit_log.html">                 audit_log.coffee               </a>                                           <a class="source" href="consts.html">                 consts.coffee               </a>                                           <a class="source" href="control_channel.html">                 control_channel.coffee               </a>                                           <a class="source" href="db.html">                 db.coffee               </a>                                           <a class="source" href="dispatcher.html">                 dispatcher.coffee               </a>                                           <a class="source" href="doctor.html">                 doctor.coffee               </a>                                           <a class="source" href="redeye.html">                 redeye.coffee               </a>                                           <a class="source" href="request_channel.html">                 request_channel.coffee               </a>                                           <a class="source" href="response_channel.html">                 response_channel.coffee               </a>                                           <a class="source" href="util.html">                 util.coffee               </a>                                           <a class="source" href="work_queue.html">                 work_queue.coffee               </a>                                           <a class="source" href="worker.html">                 worker.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               dispatcher.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Doctor = </span><span class="nx">require</span> <span class="s">&#39;./doctor&#39;</span>
<span class="nv">ControlChannel = </span><span class="nx">require</span> <span class="s">&#39;./control_channel&#39;</span>
<span class="nv">AuditLog = </span><span class="nx">require</span> <span class="s">&#39;./audit_log&#39;</span>
<span class="nv">RequestChannel = </span><span class="nx">require</span> <span class="s">&#39;./request_channel&#39;</span>
<span class="nv">ResponseChannel = </span><span class="nx">require</span> <span class="s">&#39;./response_channel&#39;</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s">&#39;underscore&#39;</span>
<span class="nx">require</span> <span class="s">&#39;./util&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The dispatcher accepts requests for keys and manages the
dependencies between jobs. It ensures that the same work
is never requested more than once, and makes sure jobs are
re-run whenever their dependencies are met.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Dispatcher</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Initializer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(options) -&gt;</span>
    <span class="vi">@deps = </span><span class="p">{}</span>
    <span class="vi">@link = </span><span class="p">{}</span>
    <span class="vi">@_test_mode = </span><span class="nx">options</span><span class="p">.</span><span class="nx">test_mode</span>
    <span class="vi">@_verbose = </span><span class="nx">options</span><span class="p">.</span><span class="nx">verbose</span>
    <span class="vi">@_idle_timeout = </span><span class="nx">options</span><span class="p">.</span><span class="nx">idle_timeout</span> <span class="o">?</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@_test_mode</span> <span class="k">then</span> <span class="mi">500</span> <span class="k">else</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="vi">@_audit_log = </span><span class="k">new</span> <span class="nx">AuditLog</span> <span class="nv">stream: </span><span class="nx">options</span><span class="p">.</span><span class="nx">audit</span>
    <span class="p">{</span><span class="nx">db_index</span><span class="p">}</span> <span class="o">=</span> <span class="nx">options</span>
    <span class="vi">@_control_channel = </span><span class="k">new</span> <span class="nx">ControlChannel</span> <span class="p">{</span><span class="nx">db_index</span><span class="p">}</span>
    <span class="vi">@_requests_channel = </span><span class="k">new</span> <span class="nx">RequestChannel</span> <span class="p">{</span><span class="nx">db_index</span><span class="p">}</span>
    <span class="vi">@_responses_channel = </span><span class="k">new</span> <span class="nx">ResponseChannel</span> <span class="p">{</span><span class="nx">db_index</span><span class="p">}</span>
    <span class="vi">@_dependency_count = </span><span class="p">{}</span>
    <span class="vi">@_state = </span><span class="p">{}</span>
    <span class="vi">@_cycles = </span><span class="p">{}</span>
    <span class="vi">@_seed_count = </span><span class="mi">0</span>
    <span class="vi">@_seeds = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Subscribe to the <code>requests</code> and <code>responses</code> channels.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">listen: </span><span class="o">-&gt;</span>
    <span class="nx">@_requests_channel</span><span class="p">.</span><span class="nx">listen</span> <span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@_requested</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span>
    <span class="nx">@_responses_channel</span><span class="p">.</span><span class="nx">listen</span> <span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">str</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@_responded</span> <span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Send quit signals to the work queues.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">quit: </span><span class="o">-&gt;</span>
    <span class="nx">@_clear_timeout</span><span class="p">()</span>
    <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">quit</span><span class="p">()</span>
    <span class="nv">finish = </span><span class="o">=&gt;</span>
      <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">delete_jobs</span><span class="p">()</span>
      <span class="nx">@_requests_channel</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="nx">@_responses_channel</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">setTimeout</span> <span class="nx">finish</span><span class="p">,</span> <span class="mi">500</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Provide a callback to be called when the dispatcher detects the process is stuck</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_stuck: </span><span class="nf">(@_stuck_callback) -&gt;</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Set the idle handler</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">on_idle: </span><span class="nf">(@_idle_handler) -&gt;</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Clear the timeout for idling</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_clear_timeout: </span><span class="o">-&gt;</span>
    <span class="nx">clearTimeout</span> <span class="nx">@_timeout</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Called when a worker requests keys. The keys requested are
recorded as dependencies, and any new key requests are
turned into new jobs. You can request the key <code>!reset</code> in
order to flush the dependency graph.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_requested: </span><span class="nf">(source, keys) -&gt;</span>
    <span class="k">if</span> <span class="nx">source</span> <span class="o">==</span> <span class="s">&#39;!reset&#39;</span>
      <span class="nx">@_reset</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">source</span> <span class="o">==</span> <span class="s">&#39;!invalidate&#39;</span>
      <span class="nx">@_invalidate</span> <span class="nx">key</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">source</span> <span class="o">==</span> <span class="s">&#39;!dep&#39;</span>
      <span class="nx">@_record_dep</span> <span class="nx">keys</span><span class="p">...</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">source</span> <span class="o">==</span> <span class="s">&#39;!dump&#39;</span>
      <span class="nx">@_dump_link</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">source</span> <span class="o">==</span> <span class="s">&#39;!replace&#39;</span>
      <span class="nx">@_replace</span> <span class="nx">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">keys</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">@_new_request</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span>
    <span class="k">else</span>
      <span class="nx">@_seed</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Store the current links in the 'deps' key</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_dump_link: </span><span class="o">-&gt;</span>
    <span class="nx">@_db</span><span class="p">().</span><span class="nx">set</span> <span class="s">&#39;deps&#39;</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">@link</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>The given key is a 'seed' request. In test mode, completion of
the seed request signals termination of the workers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_seed: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@_seeds</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">@_seed_count</span><span class="o">++</span>
    <span class="nx">@_new_request</span> <span class="s">&#39;!seed&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Forget everything we know about dependency state.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_reset: </span><span class="o">-&gt;</span>
    <span class="vi">@_dependency_count = </span><span class="p">{}</span>
    <span class="vi">@_state = </span><span class="p">{}</span>
    <span class="vi">@_cycles = </span><span class="p">{}</span>
    <span class="vi">@link = </span><span class="p">{}</span>
    <span class="vi">@deps = </span><span class="p">{}</span>
    <span class="vi">@doc = </span><span class="kc">null</span>
    <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Invalidate the given key, then replace its value with the given string</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_replace: </span><span class="nf">(key, str) -&gt;</span>
    <span class="nx">@_invalidate</span> <span class="nx">key</span>
    <span class="nx">@_db</span><span class="p">().</span><span class="nx">set</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">str</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Remove the key or key-pattern from the DB and recursively invalidate its dependent keys</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_invalidate: </span><span class="nf">(pattern) -&gt;</span>
    <span class="nv">kill = </span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@_db</span><span class="p">().</span><span class="nx">del</span> <span class="nx">key</span>
      <span class="nv">deps = </span><span class="nx">@link</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?</span> <span class="p">[]</span>
      <span class="k">delete</span> <span class="nx">@link</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">delete</span> <span class="nx">@_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="nx">@_remove_cycles_containing</span> <span class="nx">key</span>
      <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">erase</span> <span class="nx">key</span>
      <span class="nx">kill</span> <span class="nx">dep</span> <span class="k">for</span> <span class="nx">dep</span> <span class="k">in</span> <span class="nx">deps</span>
    <span class="k">if</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      <span class="nx">@_db</span><span class="p">().</span><span class="nx">keys</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nf">(e, keys) -&gt;</span>
        <span class="nx">kill</span> <span class="nx">key</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
    <span class="k">else</span>
      <span class="nx">kill</span> <span class="nx">pattern</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Handle a request we've never seen before from a given source
job that depends on the given keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_new_request: </span><span class="nf">(source, keys) -&gt;</span>
    <span class="nx">@_audit_log</span><span class="p">.</span><span class="nx">request</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span> <span class="nx">unless</span> <span class="nx">source</span> <span class="o">==</span> <span class="s">&#39;!seed&#39;</span>
    <span class="nx">@_reset_timeout</span><span class="p">()</span>
    <span class="nx">@_dependency_count</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">@_handle_request</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Reset the timer that checks if the process is broken</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_reset_timeout: </span><span class="o">-&gt;</span>
    <span class="nx">@_clear_timeout</span><span class="p">()</span>
    <span class="vi">@_timeout = </span><span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@_idle</span><span class="p">()),</span> <span class="nx">@_idle_timeout</span>
  </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Add an explicit dependency to <code>@link</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_record_dep: </span><span class="nf">(source, key) -&gt;</span>
    <span class="p">(</span><span class="nx">@link</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]).</span><span class="nx">push</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Handle the requested keys by marking them as dependencies
and turning any unsatisfied ones into new jobs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_handle_request: </span><span class="nf">(source, keys) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="nx">keys</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Mark the key as a dependency of the given source job. If
the key is already completed, then do nothing; if it has
not been previously requested, create a new job for it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">unless</span> <span class="nx">@_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;done&#39;</span>
        <span class="nx">@_request_dependency</span> <span class="nx">key</span> <span class="nx">unless</span> <span class="nx">@_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
        <span class="p">(</span><span class="nx">@deps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]).</span><span class="nx">push</span> <span class="nx">source</span>
        <span class="nx">@_dependency_count</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span><span class="o">++</span>
    <span class="nx">unless</span> <span class="nx">@_dependency_count</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span>
      <span class="nx">@_reschedule</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Take an unmet dependency from the latest request and push
it onto the <code>jobs</code> queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_request_dependency: </span><span class="nf">(req) -&gt;</span>
    <span class="nx">@_state</span><span class="p">[</span><span class="nx">req</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;wait&#39;</span>
    <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">push_job</span> <span class="nx">req</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Signal a job to run again by sending a resume message</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_reschedule: </span><span class="nf">(key) -&gt;</span>
    <span class="k">delete</span> <span class="nx">@_dependency_count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@_unseed</span><span class="p">()</span> <span class="k">if</span> <span class="nx">key</span> <span class="o">==</span> <span class="s">&#39;!seed&#39;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;done&#39;</span>
    <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">resume</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>The seed request was completed. In test mode, quit the workers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_unseed: </span><span class="o">-&gt;</span>
    <span class="nx">@_dump_link</span><span class="p">()</span>
    <span class="nx">unless</span> <span class="o">--</span><span class="nx">@_seed_count</span>
      <span class="nx">@_clear_timeout</span><span class="p">()</span>
      <span class="nx">@quit</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@_test_mode</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Called when a key is completed. Any jobs depending on this
key are updated, and if they have no more dependencies, are
signalled to run again.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_responded: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">@_reset_timeout</span><span class="p">()</span>
    <span class="nx">@_audit_log</span><span class="p">.</span><span class="nx">response</span> <span class="nx">key</span>
    <span class="nx">@_state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;done&#39;</span>
    <span class="nv">targets = </span><span class="nx">@deps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?</span> <span class="p">[]</span>
    <span class="k">delete</span> <span class="nx">@deps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">@_progress</span> <span class="nx">targets</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Make progress on each of the given keys by decrementing
their count of remaining dependencies. When any reaches
zero, it is rescheduled.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_progress: </span><span class="nf">(keys) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
      <span class="nx">unless</span> <span class="o">--</span><span class="nx">@_dependency_count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nx">@_reschedule</span> <span class="nx">key</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Activate a handler for idle timeouts. By default, this means
calling the doctor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_idle: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@_idle_handler</span>
      <span class="nx">@_idle_handler</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">@_call_doctor</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Let the doctor figure out what's wrong here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_call_doctor: </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Oops... calling the doctor!&quot;</span> <span class="k">if</span> <span class="nx">@_verbose</span>
    <span class="vi">@doc = </span><span class="k">new</span> <span class="nx">Doctor</span> <span class="nx">@deps</span><span class="p">,</span> <span class="nx">@_state</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">@_seeds</span><span class="p">)</span>
    <span class="nx">@doc</span><span class="p">.</span><span class="nx">diagnose</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">@doc</span><span class="p">.</span><span class="nx">is_stuck</span><span class="p">()</span>
      <span class="nx">@doc</span><span class="p">.</span><span class="nx">report</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@_verbose</span>
      <span class="nx">@_recover</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Hmm, the doctor couldn&#39;t find anything amiss...&quot;</span> <span class="k">if</span> <span class="nx">@_verbose</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Recover from a stuck process.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_recover: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@doc</span><span class="p">.</span><span class="nx">recoverable</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">cycle</span> <span class="k">in</span> <span class="nx">@doc</span><span class="p">.</span><span class="nx">cycles</span>
        <span class="k">return</span> <span class="nx">@_fail_recovery</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@_seen_cycle</span> <span class="nx">cycle</span>
      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">deps</span> <span class="k">of</span> <span class="nx">@doc</span><span class="p">.</span><span class="nx">cycle_dependencies</span><span class="p">()</span>
        <span class="nx">@_signal_worker_of_cycles</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">deps</span>
    <span class="k">else</span>
      <span class="nx">@_fail_recovery</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Determine if we've seen this cycle before</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_seen_cycle: </span><span class="nf">(cycle) -&gt;</span>
    <span class="nv">key = </span><span class="nx">cycle</span><span class="p">.</span><span class="nx">sort</span><span class="p">().</span><span class="nx">join</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">@_cycles</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">@_cycles</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="kc">false</span>
  </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Remove any cycle that includes the given key</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_remove_cycles_containing: </span><span class="nf">(key) -&gt;</span>
    <span class="k">for</span> <span class="nx">cycle</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">@_cycles</span>
      <span class="k">delete</span> <span class="nx">@_cycles</span><span class="p">[</span><span class="nx">cycle</span><span class="p">]</span> <span class="k">if</span> <span class="nx">cycle</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Recovery failed, let the callback know about it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_fail_recovery: </span><span class="o">-&gt;</span>
    <span class="nx">@_stuck_callback</span><span class="o">?</span><span class="p">(</span><span class="nx">@doc</span><span class="p">,</span> <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">db</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Tell the given worker that they have cycle dependencies.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_signal_worker_of_cycles: </span><span class="nf">(key, deps) -&gt;</span>
    <span class="nx">@_remove_dependencies</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">deps</span>
    <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">cycle</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">deps</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Remove given dependencies from the key</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_remove_dependencies: </span><span class="nf">(key, deps) -&gt;</span>
    <span class="nx">@_dependency_count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">deps</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">@deps</span><span class="p">[</span><span class="nx">dep</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">without</span> <span class="nx">@deps</span><span class="p">[</span><span class="nx">dep</span><span class="p">],</span> <span class="nx">key</span> <span class="k">for</span> <span class="nx">dep</span> <span class="k">in</span> <span class="nx">deps</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Print a debugging statement</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_debug: </span><span class="nf">(args...) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>console.log 'dispatcher:', args...</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Grab a database hook</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_db: </span><span class="o">-&gt;</span>
    <span class="nx">@_control_channel</span><span class="p">.</span><span class="nx">db</span><span class="p">()</span>

<span class="nv">module.exports =</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Create a new dispatcher instance and start it listening for
requests. Then return the dispatcher.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">run: </span><span class="nf">(options) -&gt;</span>
    <span class="nv">dispatcher = </span><span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">(</span><span class="nx">options</span> <span class="o">?</span> <span class="p">{})</span>
    <span class="nx">dispatcher</span><span class="p">.</span><span class="nx">listen</span><span class="p">()</span>
    <span class="nx">dispatcher</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 