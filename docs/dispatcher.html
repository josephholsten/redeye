<!DOCTYPE html>  <html> <head>   <title>dispatcher.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="consts.html">                 consts.coffee               </a>                                           <a class="source" href="db.html">                 db.coffee               </a>                                           <a class="source" href="debug.html">                 debug.coffee               </a>                                           <a class="source" href="dispatcher.html">                 dispatcher.coffee               </a>                                           <a class="source" href="doctor.html">                 doctor.coffee               </a>                                           <a class="source" href="redeye.html">                 redeye.coffee               </a>                                           <a class="source" href="audit_test.html">                 audit_test.coffee               </a>                                           <a class="source" href="cycles_test.html">                 cycles_test.coffee               </a>                                           <a class="source" href="idle_test.html">                 idle_test.coffee               </a>                                           <a class="source" href="loose_ends_test.html">                 loose_ends_test.coffee               </a>                                           <a class="source" href="multi_arg_test.html">                 multi_arg_test.coffee               </a>                                           <a class="source" href="object_test.html">                 object_test.coffee               </a>                                           <a class="source" href="repetition_test.html">                 repetition_test.coffee               </a>                                           <a class="source" href="side_effects_test.html">                 side_effects_test.coffee               </a>                                           <a class="source" href="simple_test.html">                 simple_test.coffee               </a>                                           <a class="source" href="speed_test.html">                 speed_test.coffee               </a>                                           <a class="source" href="sticky_test.html">                 sticky_test.coffee               </a>                                           <a class="source" href="audit_listener.html">                 audit_listener.coffee               </a>                                           <a class="source" href="redeye_suite.html">                 redeye_suite.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               dispatcher.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">consts = </span><span class="nx">require</span> <span class="s1">&#39;./consts&#39;</span>
<span class="nv">debug = </span><span class="nx">require</span> <span class="s1">&#39;./debug&#39;</span>
<span class="nv">Doctor = </span><span class="nx">require</span> <span class="s1">&#39;./doctor&#39;</span>
<span class="nv">db = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./db&#39;</span><span class="p">)</span>
<span class="nv">_ = </span><span class="nx">require</span> <span class="s1">&#39;underscore&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>The dispatcher accepts requests for keys and manages the
dependencies between jobs. It ensures that the same work
is never requested more than once, and makes sure jobs are
re-run whenever their dependencies are met.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">Dispatcher</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Initializer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(@options) -&gt;</span>
    <span class="vi">@test_mode = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">test_mode</span>
    <span class="vi">@idle_timeout = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">idle_timeout</span> <span class="o">?</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@test_mode</span> <span class="k">then</span> <span class="mi">500</span> <span class="k">else</span> <span class="mi">10000</span><span class="p">)</span>
    <span class="vi">@audit_stream = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">audit</span>
    <span class="vi">@db = </span><span class="nx">db</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@req = </span><span class="nx">db</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@res = </span><span class="nx">db</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">db_index</span>
    <span class="vi">@resume_channel = </span><span class="s2">&quot;resume_#{@options.db_index}&quot;</span>
    <span class="vi">@count = </span><span class="p">{}</span>
    <span class="vi">@state = </span><span class="p">{}</span>
    <span class="vi">@deps = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Subscribe to the <code>requests</code> and <code>responses</code> channels.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">listen: </span><span class="o">-&gt;</span>
    <span class="nx">@req</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">str</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@requested</span> <span class="nx">str</span>
    <span class="nx">@res</span><span class="p">.</span><span class="kc">on</span> <span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">str</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@responded</span> <span class="nx">str</span>
    <span class="nx">@req</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s2">&quot;requests_#{@options.db_index}&quot;</span>
    <span class="nx">@res</span><span class="p">.</span><span class="nx">subscribe</span> <span class="s2">&quot;responses_#{@options.db_index}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Called when a worker requests keys. The keys requested are
recorded as dependencies, and any new key requests are
turned into new jobs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">requested: </span><span class="nf">(str) -&gt;</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: requested: #{str}&quot;</span>
    <span class="p">[</span><span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span><span class="p">...]</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">split</span> <span class="nx">consts</span><span class="p">.</span><span class="nx">key_sep</span>
    <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">@audit</span> <span class="s2">&quot;?#{str}&quot;</span>
      <span class="nx">@new_request</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span>
    <span class="k">else</span>
      <span class="nx">@seed</span> <span class="nx">source</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Called when a key is completed. Any jobs depending on this
key are updated, and if they have no more dependencies, are
signalled to run again.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">responded: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: responded: #{key}&quot;</span>
    <span class="nx">@audit</span> <span class="s2">&quot;!#{key}&quot;</span>
    <span class="nx">@state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;done&#39;</span>
    <span class="nv">targets = </span><span class="nx">@deps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?</span> <span class="p">[]</span>
    <span class="k">delete</span> <span class="nx">@deps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nx">@progress</span> <span class="nx">targets</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Write text to the audit stream</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">audit: </span><span class="nf">(text) -&gt;</span>
    <span class="nx">@audit_stream</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;#{text}\n&quot;</span> <span class="k">if</span> <span class="nx">@audit_stream</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The given key is a 'seed' request. In test mode, completion of
the seed request signals termination of the workers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">seed: </span><span class="nf">(key) -&gt;</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: seed: #{key}&quot;</span>
    <span class="vi">@_seed = </span><span class="nx">key</span>
    <span class="nx">@new_request</span> <span class="s1">&#39;!seed&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>The seed request was completed. In test mode, quit the workers.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unseed: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: unseed&quot;</span>
    <span class="nx">@quit</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@test_mode</span>
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Send quit signals to the work queues.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">quit: </span><span class="o">-&gt;</span>
    <span class="nx">@clear_timeout</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
      <span class="nx">@db</span><span class="p">.</span><span class="nx">rpush</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="s1">&#39;!quit&#39;</span>
    <span class="nv">finish = </span><span class="o">=&gt;</span>
      <span class="nx">@db</span><span class="p">.</span><span class="nx">del</span> <span class="s1">&#39;jobs&#39;</span>
      <span class="nx">@req</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="nx">@res</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
      <span class="nx">@db</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
    <span class="nx">setTimeout</span> <span class="nx">finish</span><span class="p">,</span> <span class="mi">500</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Make progress on each of the given keys by decrementing
their count of remaining dependencies. When any reaches
zero, it is rescheduled.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">progress: </span><span class="nf">(keys) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">keys</span>
      <span class="nx">unless</span> <span class="o">--</span><span class="nx">@count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        <span class="nx">@reschedule</span> <span class="nx">key</span>
  </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Set the idle handler</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">when_idle: </span><span class="nf">(@idle_handler) -&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Clear the timeout for idling</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">clear_timeout: </span><span class="o">-&gt;</span>
    <span class="nx">clearTimeout</span> <span class="nx">@timeout</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Reset the timer that checks if the process is broken</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reset_timeout: </span><span class="o">-&gt;</span>
    <span class="nx">@clear_timeout</span><span class="p">()</span>
    <span class="vi">@timeout = </span><span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">@idle</span><span class="p">()),</span> <span class="nx">@idle_timeout</span>
  </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Activate a handler for idle timeouts. By default, this means
calling the doctor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">idle: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: idling&quot;</span>
    <span class="k">if</span> <span class="nx">@idle_handler</span>
      <span class="nx">@idle_handler</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">@call_doctor</span><span class="p">()</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Let the doctor figure out what's wrong here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">call_doctor: </span><span class="o">-&gt;</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: calling the doctor&quot;</span>
    <span class="nx">@doc</span> <span class="o">?=</span> <span class="k">new</span> <span class="nx">Doctor</span> <span class="nx">@deps</span><span class="p">,</span> <span class="nx">@state</span><span class="p">,</span> <span class="nx">@_seed</span>
    <span class="nx">@doc</span><span class="p">.</span><span class="nx">diagnose</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>@doc.report()</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Signal a job to run again by sending a resume message</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">reschedule: </span><span class="nf">(key) -&gt;</span>
    <span class="k">delete</span> <span class="nx">@count</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@unseed</span><span class="p">()</span> <span class="k">if</span> <span class="nx">key</span> <span class="o">==</span> <span class="s1">&#39;!seed&#39;</span>
    <span class="nx">@db</span><span class="p">.</span><span class="nx">publish</span> <span class="nx">@resume_channel</span><span class="p">,</span> <span class="nx">key</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Handle a request we've never seen before from a given source
job that depends on the given keys.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">new_request: </span><span class="nf">(source, keys) -&gt;</span>
    <span class="vi">@reqs = </span><span class="p">[]</span>
    <span class="nx">@reset_timeout</span><span class="p">()</span>
    <span class="nx">@count</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: new_request: source:&quot;</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="s2">&quot;keys:&quot;</span><span class="p">,</span> <span class="nx">keys</span>
    <span class="nx">@handle_request</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">keys</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Handle the requested keys by marking them as dependencies
and turning any unsatisfied ones into new jobs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">handle_request: </span><span class="nf">(source, keys) -&gt;</span>
    <span class="k">for</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="nx">keys</span>
      <span class="nx">@mark_dependency</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">key</span>
    <span class="k">if</span> <span class="nx">@count</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span>
      <span class="nx">@request_dependencies</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: already satisfied: #{source}&quot;</span>
      <span class="nx">@reschedule</span> <span class="nx">source</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Mark the key as a dependency of the given source job. If
the key is already completed, then do nothing; if it has
not been previously requested, create a new job for it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">mark_dependency: </span><span class="nf">(source, key) -&gt;</span>
    <span class="k">switch</span> <span class="nx">@state</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">when</span> <span class="s1">&#39;done&#39;</span> <span class="k">then</span> <span class="k">return</span>
      <span class="k">when</span> <span class="kc">undefined</span> <span class="k">then</span> <span class="nx">@reqs</span><span class="p">.</span><span class="nx">push</span> <span class="nx">key</span>
    <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: #{source} now depends on #{key}&quot;</span>
    <span class="p">(</span><span class="nx">@deps</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]).</span><span class="nx">push</span> <span class="nx">source</span>
    <span class="nx">@count</span><span class="p">[</span><span class="nx">source</span><span class="p">]</span><span class="o">++</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Take the unmet dependencies from the latest request and push
them onto the <code>jobs</code> queue.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">request_dependencies: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">req</span> <span class="k">in</span> <span class="nx">@reqs</span>
      <span class="nx">debug</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;dispatcher: asking for: #{req}&quot;</span>
      <span class="nx">@state</span><span class="p">[</span><span class="nx">req</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;wait&#39;</span>
      <span class="nx">@db</span><span class="p">.</span><span class="nx">rpush</span> <span class="s1">&#39;jobs&#39;</span><span class="p">,</span> <span class="nx">req</span>
      

<span class="nv">module.exports =</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Create a new dispatcher instance and start it listening for
requests. Then return the dispatcher.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">run: </span><span class="nf">(options) -&gt;</span>
    <span class="nv">dispatcher = </span><span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">(</span><span class="nx">options</span> <span class="o">?</span> <span class="p">{})</span>
    <span class="nx">dispatcher</span><span class="p">.</span><span class="nx">listen</span><span class="p">()</span>
    <span class="nx">dispatcher</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 